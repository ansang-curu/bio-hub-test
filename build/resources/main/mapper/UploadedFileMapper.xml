<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.biodatahub.repository.UploadedFileRepository">

    <resultMap id="UploadedFileResultMap" type="com.biodatahub.model.UploadedFile">
        <id property="id" column="id"/>
        <result property="fileId" column="file_id"/>
        <result property="originalName" column="original_name"/>
        <result property="filePath" column="file_path"/>
        <result property="fileSize" column="file_size"/>
        <result property="fileType" column="file_type"/>
        <result property="uploadStatus" column="upload_status"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <insert id="insertFile" parameterType="com.biodatahub.model.UploadedFile" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO uploaded_files (
            file_id, original_name, file_path, file_size, file_type, 
            upload_status
        ) VALUES (
            #{fileId}, #{originalName}, #{filePath}, #{fileSize}, #{fileType},
            #{uploadStatus}
        )
    </insert>

    <select id="findByFileId" parameterType="string" resultMap="UploadedFileResultMap">
        SELECT * FROM uploaded_files WHERE file_id = #{fileId}
    </select>

    <select id="findById" parameterType="long" resultMap="UploadedFileResultMap">
        SELECT * FROM uploaded_files WHERE id = #{id}
    </select>

    <select id="findAll" resultMap="UploadedFileResultMap">
        SELECT * FROM uploaded_files ORDER BY created_at DESC
    </select>

    <select id="findByStatus" resultMap="UploadedFileResultMap">
        SELECT * FROM uploaded_files 
        WHERE upload_status = #{status} 
        ORDER BY created_at DESC
    </select>

    <select id="findRecentFiles" parameterType="int" resultMap="UploadedFileResultMap">
        SELECT * FROM uploaded_files 
        ORDER BY created_at DESC 
        LIMIT #{limit}
    </select>

    <update id="updateUploadStatus">
        UPDATE uploaded_files 
        SET upload_status = #{status}, updated_at = CURRENT_TIMESTAMP
        WHERE file_id = #{fileId}
    </update>


    <update id="updateFilePath">
        UPDATE uploaded_files 
        SET file_path = #{filePath}, updated_at = CURRENT_TIMESTAMP
        WHERE file_id = #{fileId}
    </update>

    <delete id="deleteByFileId" parameterType="string">
        DELETE FROM uploaded_files WHERE file_id = #{fileId}
    </delete>

    <delete id="deleteById" parameterType="long">
        DELETE FROM uploaded_files WHERE id = #{id}
    </delete>

    <select id="countByStatus" resultType="int">
        SELECT COUNT(*) FROM uploaded_files WHERE upload_status = #{status}
    </select>

    <select id="getTotalUploadedSize" resultType="long">
        SELECT COALESCE(SUM(file_size), 0) FROM uploaded_files 
        WHERE upload_status = 'COMPLETED'
    </select>

</mapper>